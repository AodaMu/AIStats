@startuml AIStats_Entity_Relationship
!theme plain
skinparam linetype ortho

title AIStats Data Model (Session State Architecture)

' 定义实体
entity "SessionState" as Session {
  * session_id : String <<PK>>
  --
  created_at : DateTime
  updated_at : DateTime
}

entity "Data" as Data {
  * data_id : String <<PK>>
  --
  data_name : String
  data : DataFrame
  row_count : Integer
  col_count : Integer
  memory_usage : Float
  import_time : DateTime
}

entity "VariableLabels" as Labels {
  * label_id : String <<PK>>
  --
  var_name : String
  label : String
  var_type : String {continuous, categorical}
  source : String {manual, VLOOKUP}
}

entity "StatisticalResults" as Results {
  * result_id : String <<PK>>
  --
  analysis_type : String
  analysis_time : DateTime
  variables : List[String]
  statistics : JSON
  p_value : Float
  significant : Boolean
  result_table : DataFrame
}

entity "Visualization" as Viz {
  * viz_id : String <<PK>>
  --
  chart_type : String
  created_at : DateTime
  x_var : String
  y_var : String
  z_var : String (optional)
  group_var : String (optional)
  figure : PlotlyFigure
}

entity "AIConfig" as AIConfig {
  * config_id : String <<PK>>
  --
  api_key : String (encrypted)
  api_base : String
  model_name : String
  temperature : Float
  max_tokens : Integer
  enabled : Boolean
}

entity "ChatHistory" as Chat {
  * message_id : String <<PK>>
  --
  role : String {user, assistant, system}
  content : Text
  timestamp : DateTime
  function_call : JSON (optional)
  function_result : JSON (optional)
}

entity "FunctionDefinition" as Func {
  * function_id : String <<PK>>
  --
  name : String
  description : Text
  parameters : JSON
  return_type : String
  module : String
}

' 定义关系
Session ||--|| Data : "holds"
Session ||--|{ Labels : "manages"
Session ||--|{ Results : "stores"
Session ||--|{ Viz : "saves"
Session ||--|| AIConfig : "configures"
Session ||--|{ Chat : "records"

Data ||--|{ Labels : "maps to"
note on link
  Each column maps
  to a variable label
end note

Results }|--|| Data : "based on"
note on link
  Analysis based on
  current dataset
end note

Viz }|--|| Data : "visualizes"
note on link
  Chart visualizes
  dataset variables
end note

Chat }|--o| Results : "references"
note on link
  AI chat may
  reference results
end note

Chat }|--o| Func : "calls"
note on link
  AI calls functions
  via Function Calling
end note

Results }|--|| Func : "generated by"
note on link
  Results generated
  by function execution
end note

' 添加说明
note right of Session
  <b>Session State</b>
  Streamlit session management
  Stores all user data and state
  
  <b>Features:</b>
  - In-memory, isolated
  - Auto serialization
  - Supports any Python object
end note

note right of Data
  <b>Core Data Entity</b>
  Stores uploaded dataset
  
  <b>Supported formats:</b>
  - CSV
  - Excel (xlsx/xls)
  
  <b>Size limit:</b>
  Recommended < 100MB
end note

note right of Func
  <b>16 Statistical Functions</b>
  Including:
  - Descriptive stats
  - t-tests (one/independent/paired)
  - ANOVA/LSD
  - Correlation
  - Linear/Logistic regression
  - Reliability analysis
  - Mediation effect
end note

note bottom of Chat
  <b>Multi-turn Dialog</b>
  Each message contains:
  - User input
  - AI response
  - Function call record
  
  Context limit: ~8k tokens
end note

@enduml

