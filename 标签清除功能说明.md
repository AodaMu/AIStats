# 标签清除功能说明

## 问题描述
在使用 AIStats 的值标签功能时，可能会遇到以下残留问题：
1. 切换数据文件后，旧数据的标签仍然存在
2. 手动添加的值（数据中不存在的值）残留
3. 删除数据后标签配置未清除
4. **AI对话历史中包含旧标签的统计结果**（⭐ 最常见的残留问题）
5. 统计结果缓存中保存了旧的标签信息

## 解决方案

### 1. 自动检测和提示（数据视图）

#### 📥 加载新数据时
当您在 **📁 数据视图** 中上传新的数据文件时：
- ✅ 系统会自动检测是否存在旧的配置（标签、对话历史）
- ✅ 如果检测到旧配置，会弹出提示框询问您：
  - **🗑️ 清除旧数据**（推荐）：删除所有旧配置，包括：
    - 值标签配置
    - AI对话历史
    - 统计结果缓存
  - **📌 保留旧数据**：保留旧配置（可能导致混淆，需要手动调整）

#### 🗑️ 删除数据时
当您点击 **🗑️ 删除数据** 按钮时：
- ✅ 自动清除以下所有内容：
  - 数据本身
  - 值标签配置
  - AI对话历史
  - 统计结果缓存
- ✅ 不会产生任何残留

### 2. 手动清除功能（值标签视图）

在 **🏷️ 值标签** 页面，提供了三个层级的清除功能：

#### 方式一：清除当前变量的标签
- 位置：编辑标签区域，"💾 保存所有标签" 按钮旁边
- 按钮：**🗑️ 清除当前变量标签**
- 作用：清除当前选中变量的：
  - 所有值标签（包括手动添加的值）
  - 相关的AI对话历史
  - 相关的统计结果缓存

#### 方式二：清除所有变量的标签
- 位置：页面底部，"📋 已设置的值标签" 区域下方
- 按钮：**🗑️ 清除所有变量的标签**
- 作用：清除以下所有内容：
  - 所有变量的所有标签
  - 所有AI对话历史
  - 所有统计结果缓存

#### 方式三：程序化清除（高级）
```python
from src.lib.variable_labels import clear_variable_labels

# 清除指定变量的标签
clear_variable_labels("变量名")

# 清除所有标签
clear_variable_labels()
```

## 使用建议

### 最佳实践
1. **切换数据时**：建议清除旧标签和对话历史，避免混淆
2. **调试时**：如果标签设置错误，使用"清除当前变量标签"重新设置
3. **重新开始**：使用"清除所有变量的标签"一键重置
4. **发现残留时**：
   - 如果AI分析结果中出现旧标签（如"六年级"但数据中已无此值）
   - 前往 🏷️ 值标签页面，点击"🗑️ 清除所有变量的标签"
   - 或前往 📁 数据视图，删除数据后重新导入

### 注意事项
⚠️ **清除操作不可恢复**，请谨慎操作  
⚠️ 清除标签会同时清除AI对话历史和统计结果缓存  
💡 如果只想清除对话历史，可在AI视图中点击"🗑️ 清空对话"按钮  
💡 如果需要保存标签配置，建议先导出配置文件（功能待开发）

### 常见问题

#### Q1: 为什么AI分析中还显示"六年级"等旧标签？
**A:** 这是因为旧的统计结果保存在AI对话历史中。解决方法：
1. 前往 🏷️ 值标签页面
2. 点击"🗑️ 清除所有变量的标签"按钮
3. 这会同时清除AI对话历史

#### Q2: 我只想清除对话历史，不想清除标签怎么办？
**A:** 前往 🤖 AI 辅助分析页面，点击"🗑️ 清空对话"按钮即可

#### Q3: 切换数据后需要手动清除吗？
**A:** 不需要！系统会自动检测并弹出提示框，您只需选择"清除旧数据"即可

## 功能对比

| 功能 | 触发时机 | 作用范围 | 是否自动 |
|------|---------|---------|---------|
| 加载新数据提示 | 上传不同的数据文件 | 标签+对话+统计 | 半自动（需确认） |
| 删除数据清除 | 删除当前数据 | 标签+对话+统计 | 自动 |
| 清除当前变量 | 手动点击按钮 | 单个变量+对话+统计 | 手动 |
| 清除所有标签 | 手动点击按钮 | 所有标签+对话+统计 | 手动 |
| 清空对话（AI视图）| 手动点击按钮 | 仅对话历史 | 手动 |

## 更新日志

### 2025-11-06
- ✅ 新增：数据视图中加载新数据时自动检测旧标签
- ✅ 新增：删除数据时自动清除关联标签
- ✅ 新增：值标签页面的"清除当前变量标签"按钮
- ✅ 新增：值标签页面的"清除所有变量的标签"按钮
- ✅ 新增：`clear_variable_labels()` 函数，支持程序化清除

---

如有问题，请在 GitHub 提交 Issue。

