# 变量类型智能识别功能

## 问题背景

用户询问"统计各个年级人数，占比多少"时，期望看到：
- 7年级：X人，占比XX%
- 8年级：Y人，占比YY%
- 9年级：Z人，占比ZZ%

但系统原本把"年级"当作**数值型变量**，计算了均值7.85、标准差0.83等，这是错误的。

## 解决方案

### 智能识别逻辑

现在系统会智能判断变量类型：

#### 1. 数值型连续变量
- **条件**：数据类型是数字，且**没有**设置值标签，且唯一值 > 15个
- **统计**：均值、标准差、中位数、四分位数等
- **示例**：身高、体重、成绩、年龄

#### 2. 分类变量（数值编码）
- **条件**：
  - 数据类型是数字，但**设置了值标签**
  - 或：唯一值 ≤ 15个
- **统计**：频次、占比（包括频次为0的值）
- **示例**：
  - 年级（7、8、9）
  - 满意度（1-5分）
  - 性别（0=女，1=男）

#### 3. 普通分类变量
- **条件**：数据类型是文本/字符串
- **统计**：频次、占比
- **示例**：颜色、地区、职业

#### 4. 多选题
- **条件**：包含分号分隔符（;）
- **统计**：各选项的选择人数、百分比
- **示例**："选项A;选项B;选项C"

## 核心规则

### ⭐ 关键判断条件

```python
# 如果满足以下任一条件，数值型变量会被当作分类变量：
1. 设置了值标签（value_labels 不为空）
2. 唯一值 ≤ 15个
```

### 为什么是15个？

- 太小（如≤5）：会把一些连续变量误判（如年龄18-22岁）
- 太大（如≥50）：会把真正的分类变量当作连续变量（如学号）
- **15个**是一个平衡点：
  - 年级（7-9）→ 3个值 → ✅ 分类变量
  - 满意度（1-5）→ 5个值 → ✅ 分类变量
  - 评分（0-10）→ 11个值 → ✅ 分类变量
  - 年龄（18-80）→ >15个值 → ✅ 数值变量

## 使用建议

### 1. 为分类变量设置值标签（推荐）

如果您的变量是分类变量，建议设置值标签：

```
年级：
7 = 初一
8 = 初二
9 = 初三
```

这样系统会**自动识别为分类变量**，统计频次和占比。

### 2. 无需设置标签的情况

如果唯一值 ≤ 15个，即使不设置标签，也会被识别为分类变量：

```
性别：0, 1  → 自动识别为分类变量
满意度：1, 2, 3, 4, 5  → 自动识别为分类变量
```

### 3. 强制当作数值变量

如果您希望把分类变量当作数值变量（计算均值），可以：
- 不设置值标签
- 确保唯一值 > 15个
- 或在统计视图中使用"描述统计"手动选择

## 示例对比

### 示例1：年级（设置了值标签）

**设置标签后**：
```
年级_Grade：
7 = 初一
8 = 初二  
9 = 初三
```

**AI统计结果**：
```
年级分布：
- 7（初一）：5人，25%
- 8（初二）：10人，50%
- 9（初三）：5人，25%
```

### 示例2：年龄（未设置标签，唯一值>15）

**统计结果**：
```
年龄统计：
- 样本量：20
- 均值：35.5岁
- 标准差：8.2
- 范围：18-65岁
```

## 更新日志

### 2025-11-06
- ✅ 新增：智能识别数值型分类变量
- ✅ 新增：设置了值标签的数值变量自动当作分类变量
- ✅ 新增：唯一值≤15的数值变量自动当作分类变量
- ✅ 修复：年级等变量被错误计算均值的问题

---

如有问题，请在 GitHub 提交 Issue。

